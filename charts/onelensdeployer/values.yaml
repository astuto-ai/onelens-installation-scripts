# ==================================================================================
# SHARED RBAC CONFIGURATION
# ==================================================================================
# Both the installation job and the updater cronjob use the same RBAC permissions
# This follows the principle of least privilege with:
# - Namespace-scoped: Full control over the onelens-agent namespace (Role)
# - Cluster-scoped: Minimal permissions restricted to specific resources (ClusterRole)
rbac:
  # Namespace-scoped permissions - we own all resources in this namespace
  role:
    enabled: true
    name: onelensdeployer-role
    rules:
      # Full control over all namespace-scoped resources - we own this namespace
      - apiGroups: ["*"]
        resources: ["*"]
        verbs: ["*"]
  roleBinding:
    enabled: true
    name: onelensdeployer-rolebinding
  
  # Cluster-scoped permissions - minimal with strict resourceNames restrictions
  clusterRole:
    name: onelensdeployer-clusterrole
    rules:
      # StorageClass permissions - we own this resource, restricted by resourceNames
      - apiGroups: ["storage.k8s.io"]
        resources: ["storageclasses"]
        verbs: ["*"]
        resourceNames:
          - onelens-sc
      # Cluster-scoped READ-ONLY permissions required to manage ClusterRoles
      # These permissions are needed because when you patch a ClusterRole (ClusterRole for prometheus-server, kube-state-metrics, etc.),
      # you must have all the permissions that ClusterRole grants (escalation protection)
      - apiGroups: [""]
        resources: ["namespaces", "nodes", "pods"]
        verbs: ["get", "list"]
      - apiGroups: ["apps"]
        resources: ["daemonsets", "deployments", "statefulsets"]
        verbs: ["get", "list"]
      - apiGroups: ["autoscaling"]
        resources: ["horizontalpodautoscalers"]
        verbs: ["get", "list"]
      - apiGroups: ["batch"]
        resources: ["cronjobs", "jobs"]
        verbs: ["get", "list"]
      # ClusterRole permissions - we own these resources, restricted by resourceNames
      - apiGroups: ["rbac.authorization.k8s.io"]
        resources: ["clusterroles"]
        verbs: ["*"]
        resourceNames:
          - onelens-agent-kube-state-metrics
          - onelens-agent-prometheus-opencost-exporter
          - onelens-agent-prometheus-server
          - onelens-agent-workload-reader
          - onelensdeployer-clusterrole
      # ClusterRoleBinding permissions - we own these resources, restricted by resourceNames
      - apiGroups: ["rbac.authorization.k8s.io"]
        resources: ["clusterrolebindings"]
        verbs: ["*"]
        resourceNames:
          - onelens-agent-kube-state-metrics
          - onelens-agent-prometheus-opencost-exporter
          - onelens-agent-prometheus-server
          - onelens-agent-workload-reader-binding
          - onelensdeployer-clusterrolebinding
  clusterRoleBinding:
    enabled: true
    name: onelensdeployer-clusterrolebinding

# ==================================================================================
# INSTALLATION JOB
# ==================================================================================
# One-time job that performs initial installation using shared RBAC permissions
job:
  enabled: true
  name: onelensdeployerjob
  image: public.ecr.aws/w7k6q5m9/onelens-deployer
  imageTag: v1.8.0
  imagePullPolicy: Always
  restartPolicy: Never
  backoffLimit: 2
  ttlSecondsAfterFinished: 300
  env:
    deployment_type: job
  resources:
    requests:
      cpu: 400m
      memory: 250Mi
    limits:
      cpu: 400m
      memory: 250Mi

  # Tolerations allow the agent to be scheduled on nodes with matching taints
  tolerations: []
  # - key: "key"
  #   operator: "Equal"
  #   value: "value"
  #   effect: "NoSchedule"
  nodeSelector: {}
  # kubernetes.io/os: linux
  serviceAccount:
    enabled: true
    name: onelensdeployerjob-sa

# ==================================================================================
# UPDATER CRONJOB
# ==================================================================================
# Periodic job that performs helm upgrade using shared RBAC permissions
cronjob:
  enabled: true
  name: onelensupdater
  schedule: "0 2 * * *"
  image: public.ecr.aws/w7k6q5m9/onelens-deployer
  imageTag: v1.8.0
  restartPolicy: Never
  env:
    deployment_type: cronjob
  resources:
    requests:
      cpu: 400m
      memory: 250Mi
    limits:
      cpu: 400m
      memory: 250Mi
  concurrencyPolicy: "Forbid" # Prevent concurrent job executions
  successfulJobsHistoryLimit: 1 # Number of successful jobs to keep
  failedJobsHistoryLimit: 1 # Number of failed jobs to keep
  suspend: false # Suspend the job
  healthCheck: false # Set to true to enable health check for cronjob pod
  # Tolerations allow the agent to be scheduled on nodes with matching taints
  tolerations: []
  # - key: "key"
  #   operator: "Equal"
  #   value: "value"
  #   effect: "NoSchedule"
  nodeSelector: {}
  # kubernetes.io/os: linux

  serviceAccount:
    enabled: true
    name: onelensupdater-sa
